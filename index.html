<html>
	<head>
		
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">

		<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.0.min.js"></script>

		<style type="text/css">
			.area1_boss {
				text-shadow: 1px 1px 1px #FFD700;
			}
		</style>
	</head>

	<body>
		<div class="container">
			<h1>GGJGame 2015</h1>

			<div class="row">
				<div class="col-md-4">
					<h2>Current Events</h2>
					<div id="currentEvents">
						<div id="battle">
							<h3>Battle with: <span id="battle_monstorName"></span></h3>
							<div class="progress">
								<div class="progress-bar" role="progressbar" id="battle_myHealth" style="width: 60%;">
									<strong>My Health: </strong><span id="battle_myHealthText">60%</span>
								</div>
							</div>
							<div class="progress">
								<div class="progress-bar" role="progressbar" id="battle_foeHealth" style="width: 60%;">
									<strong>Enemy Health: </strong><span id="battle_foeHealthText">60%</span>
								</div>
							</div>
							<h4>Current Turn</h4>
							<div class="btn-group" role="group" aria-label="battle_actions">
								<button type="button" class="btn btn-primary" id="battle_attackButton">Attack</button>
								
								<div class="btn-group" id="battle_castSpell" style="display: none;">
									<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
										Cast Spell <span class="caret"></span>
									</button>
									<ul class="dropdown-menu" role="menu" id="battle_spellList">

									</ul>
								</div>

								<div class="btn-group" id="battle_useItem" style="display: none;">
									<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
										Use Item <span class="caret"></span>
									</button>
									<ul class="dropdown-menu" role="menu" id="battle_itemList">

									</ul>
								</div>
							</div>
							<h4>Combat Log</h3>
							<div id="battle_combatLog">

							</div>
						</div>
					</div>
				</div>
				<div class="col-md-4">
					<h2>Quest Log</h2>
					<div id="partList">
						<div id="area1_bossBattle">
							<div id="area1_prologe">
								<h2>Part 1</h2>
								After the end of your long quest you reach your final goal. <em class="area1_boss">Ada-Ra, King of Elements</em> reaches out to touch his sword to your weapon but you don't have one equipped, <strong>equip one from your inventory on the side to continue</strong>...
							</div>
							<div id="area1_postEquip" style="display: none;">
								<h2>Part 2</h2>
								You pull your <span id="area1_postEquip_itemName"></span> and meet it with <em class="area1_boss">Ada-Ra</em>'s mighty sword.
								<button class="btn btn-primary" id="area1_startBattle">Start Battle</button>
							</div>
						</div>
					</div>
				</div>
				<div class="col-md-4">
					<div id="inventory">
						<h2>Inventory</h2>
						<div id="inventory_primary_weapon">
							<h3>Primary Weapon</h3>
							<ul class="nav nav-pills nav-stacked">

							</ul>
						</div>
						<div id="inventory_head">
							<h3>Head</h3>
							<ul class="nav nav-pills nav-stacked">

							</ul>
						</div>
						<div id="inventory_chestplate">
							<h3>Chest-plate</h3>
							<ul class="nav nav-pills nav-stacked">

							</ul>
						</div>
						<div id="inventory_gloves">
							<h3>Gloves</h3>
							<ul class="nav nav-pills nav-stacked">

							</ul>
						</div>
						<div id="inventory_boots">
							<h3>Boots</h3>
							<ul class="nav nav-pills nav-stacked">

							</ul>
						</div>
					</div>
				</div>
			</div>
		</div>

		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>

		<script type="text/javascript">
		$(document).ready(function () {
			function appendElements(ele, child) {
				if (typeof child == "string") {
					ele.textContent = child;
				} else if (typeof child == "object" && child instanceof Array) {
					child.forEach(function (subChild) {
						appendElements(ele, subChild);
					});
				} else if (child instanceof HTMLElement) {
					ele.appendChild(child);
				} else {
					ele.textContent = child.toString();
				}
			}

			function e(type, attrs, body) {
				var ele = document.createElement(type);
				for (var key in attrs) {
					ele.setAttribute(key, attrs[key]);
				}
				appendElements(ele, body);
				return ele;
			}

			var inventoryItems = {};

			function item_register(itemName, displayName, stats, events) {
				inventoryItems[itemName] = {
					name: itemName,
					displayName: displayName,
					stats: stats,
					events: events
				}
			}

			function item_emit(itemName, eventName, args) {
				if (inventoryItems[itemName] === undefined) {
					throw new Error("Item does not exist: " + str);
				}
				if (inventoryItems[itemName].events[eventName] !== undefined) {
					return inventoryItems[itemName].events[eventName].apply(inventoryItems[itemName], args);
				} else {
					return null;
				}
			}

			function item_get(itemName) {
				if (inventoryItems[itemName] === undefined) {
					throw new Error("Item does not exist: " + str);
				} else {
					return inventoryItems[itemName];
				}
			}

			function weapon_makeStats(minAttack, maxAttack, type) {
				return {
					minAttack: minAttack,
					maxAttack: maxAttack,
					type: type,
					slot: "primary_weapon"
				};
			}

			item_register("area1_sword", "Dave's Greatsword", weapon_makeStats(100, 500, "largeMelee"), area1_getItemEvents());
			item_register("area1_staff", "Flaming Hairy Staff", weapon_makeStats(50, 100, "magicRanged"), area1_getItemEvents());
			item_register("area1_bow", "Last Good Bow", weapon_makeStats(10, 200, "archerRanged"), area1_getItemEvents());
			item_register("area1_dagger", "Shard of Broken Time", weapon_makeStats(100, 500, "smallMelee"), area1_getItemEvents());

			var worldMonstors = {};

			function monstor_regster(id, displayElement, stats, events) {
				worldMonstors[id] = {
					id: id,
					displayElement: displayElement,
					stats: stats,
					events: events
				}
			}

			function monstor_get(monstorName) {
				if (worldMonstors[monstorName] === undefined) {
					throw new Error("Monstor does not exist: " + str);
				} else {
					return worldMonstors[monstorName];
				}
			}

			monstor_regster("area1_boss", e("em", {"class": "area1_boss"}, "Ada-Ra, King of Elements"), {
				minAttack: 20,
				maxAttack: 100,
				health: 1000,
				armor: 0.7,
				level: 1
			}, {
			});

			var charactor = {
				stats: {
					level: 1,
					armor: 0.5,
					health: 1000
				},
				equipped: {},
				inventory: {},
				spells: []
			};

			function char_itemEquiped(itemName) {
				return charactor.equipped[item_get(itemName).stats.slot] == itemName;
			}

			function char_renderInventroy() {
				console.log("char_renderInventroy");
				$("#inventory_primary_weapon>ul").empty();
				$("#inventory_head>ul").empty();
				$("#inventory_chestplate>ul").empty();
				$("#inventory_gloves>ul").empty();
				$("#inventory_boots>ul").empty();

				for (var item in charactor.inventory) {
					var entryData = charactor.inventory[item];
					var itemData = item_get(item);
					if ($("#inventory_" + itemData.stats.slot + ">ul").length > 0) {
						var ele = null;
						if (char_itemEquiped(item)) {
							ele = e("li", {"class": "active"}, e("a", {"data-name": itemData.name}, itemData.displayName));
						} else {
							ele = e("li", {}, e("a", {"data-name": itemData.name}, itemData.displayName));
						}
						$(ele).children("a").click(function (e) {
							e.preventDefault();
							char_equipItem($(this).attr("data-name"));
						});
						$("#inventory_" + itemData.stats.slot + ">ul").append(ele);
					} else {
						throw new Error("Bad Slot: " + itemData.stats.slot)
					}
				}
			}

			function char_equipItem(itemName) {
				charactor.equipped[item_get(itemName).stats.slot] = itemName;
				item_emit(itemName, "equip", []);
				char_renderInventroy();
			}

			function char_addToInventory(str) {
				if (inventoryItems[str] === undefined) {
					throw new Error("Item does not exist: " + str);
				}

				if (charactor.inventory[str] === undefined) {
					charactor.inventory[str] = {
						count: 0
					};
				}

				charactor.inventory[str].count++;

				item_emit(str, "add", []);
			}

			function char_getWeaponDamage() {
				var currentWeapon = item_get(charactor.equipped["primary_weapon"]);
				var dmg = rand(currentWeapon.stats.minAttack, currentWeapon.stats.maxAttack);

				item_emit(charactor.equipped["primary_weapon"], "swing", [dmg]);
				return dmg;
			}

			var currentBattle = {
				foe: null,
				ownMaxHealth: null,
				ownHealth: null,
				foeMaxHealth: null,
				foeHealth: null,
				callback: null
			};

			function battle_begin(monstorName, cb) {
				currentBattle.foe = monstorName;
				currentBattle.ownHealth = currentBattle.ownMaxHealth = charactor.stats.health;
				currentBattle.foeHealth = currentBattle.foeMaxHealth =  monstor_get(monstorName).stats.health;
				currentBattle.callback = cb;

				$("#battle").show();
				$("#battle_monstorName").empty().append(monstor_get(monstorName).displayElement.cloneNode(true));

				// Build spell list
				charactor.spells.forEach(function (spellName) {

				});

				battle_renderHealth();
			}

			function battle_attack() {
				console.log("battle_attack");

				var ownDmg = char_getWeaponDamage();

				if (ownDmg > 0) {
					battle_log(true, "Hit for " + ownDmg + " damage");
				} else {
					battle_log(true, "Missed");
				}

				currentBattle.foeHealth -= ownDmg;

				if (currentBattle.foeHealth < 0) {
					battle_end();
				} else {
					battle_processTurn();
				}
			}

			function battle_renderHealth() {
				var myHealthValue = (currentBattle.ownHealth / currentBattle.ownMaxHealth * 100).toFixed(2) + "%",
					foeHealthValue = (currentBattle.foeHealth / currentBattle.foeMaxHealth * 100).toFixed(2) + "%";
				$("#battle_myHealth")[0].style.width = myHealthValue;
				$("#battle_myHealthText").text(myHealthValue);
				$("#battle_foeHealth")[0].style.width = foeHealthValue;
				$("#battle_foeHealthText").text(foeHealthValue);
			}

			function battle_processTurn() {
				// monster attack
				
				var foeDmg = monstor_getWeaponDamage();

				if (foeDmg > 0) {
					battle_log(false, "Hit for " + foeDmg + " damage");
				} else {
					battle_log(false, "Missed")
				}
			}

			function battle_end() {
				var victroy = false;

				if (currentBattle.foeHealth < 0 && currentBattle.ownHealth > 0) {
					victroy = true;
				}

				$("#battle").hide();

				currentBattle.callback(victroy);
			}

			// Hide inital items
			$("#partList").children().each(function (i, element) {
				$(element).hide();
			});

			$("#inventory").hide();
			$("#inventory_primary_weapon").hide();
			$("#inventory_head").hide();
			$("#inventory_chestplate").hide();
			$("#inventory_gloves").hide();
			$("#inventory_boots").hide();

			$("#battle").hide();
			$("#battle_attackButton").click(function (e) {
				e.preventDefault();
				battle_attack();
			});

			// area1: Prologue + credits
			function area1_start() {
				$("#area1_bossBattle").show();

				$("#inventory").show();
				$("#inventory_primary_weapon").show();

				char_addToInventory("area1_sword");
				char_addToInventory("area1_staff");
				char_addToInventory("area1_bow");
				char_addToInventory("area1_dagger");
				char_renderInventroy();
			}

			function area1_getItemEvents() {
				return {
					"equip": function () {
						area1_equipedItem(this.name);
					},
					"swing": function () {
						area1_swingItem(this.name);
					}
				};
			}

			function area1_equipedItem(itemName) {
				console.log("area1_equipedItem");
				$("#area1_postEquip").show();
				$("#area1_postEquip_itemName").text(item_get(itemName).displayName);
				$("#area1_startBattle").click(function (e) {
					e.preventDefault();
					area1_beginBossBattle();
				});
			}

			function area1_beginBossBattle() {
				console.log("area1_beginBossBattle");
				battle_begin("area1_boss");
			}

			function area1_swingItem(itemName) {
				console.log("area1_swingItem", itemName);
			}

			area1_start();
		});
		</script>
	</body>
</html>