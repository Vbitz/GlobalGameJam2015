<html>
	<head>
		
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">

		<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.0.min.js"></script>

		<style type="text/css">
			.area1_boss {
				text-shadow: 1px 1px 1px #FFD700;
			}
		</style>
	</head>

	<body>
		<div class="container-fluid">
			<h1>GGJGame 2015</h1>

			<div class="jumbotron" id="area1_win" style="display: none;">
				<h1>Game, Over! You WIN.</h1>
				<button type="button" class="btn btn-primary">What do I do now?</button>
			</div>

			<div class="row" id="gameContainer">
				<button type="button" class="btn btn-default" onclick="area2_start();">Skip Area 1</button>

				<div class="col-md-4">
					<h2>Current Events</h2>
					<div id="currentEvents">
						<div id="battle">
							<h3>Battle with: <span id="battle_monsterName"></span></h3>
							<div class="progress">
								<div class="progress-bar" role="progressbar" id="battle_myHealth" style="width: 60%;">
									<strong>My Health: </strong><span id="battle_myHealthText">60%</span>
								</div>
							</div>
							<div class="progress">
								<div class="progress-bar" role="progressbar" id="battle_foeHealth" style="width: 60%;">
									<strong>Enemy Health: </strong><span id="battle_foeHealthText">60%</span>
								</div>
							</div>
							<div class="btn-group" role="group" aria-label="battle_actions" id="battle_actions">
								<button type="button" class="btn btn-default"><strong>Battle Actions: </button>

								<button type="button" class="btn btn-primary" id="battle_attackButton">Attack</button>
								
								<div class="btn-group" id="battle_castSpell" style="display: none;">
									<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
										Cast Spell <span class="caret"></span>
									</button>
									<ul class="dropdown-menu" role="menu" id="battle_spellList">

									</ul>
								</div>

								<div class="btn-group" id="battle_useItem" style="display: none;">
									<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
										Use Item <span class="caret"></span>
									</button>
									<ul class="dropdown-menu" role="menu" id="battle_itemList">

									</ul>
								</div>
							</div>
							<button type="button" class="btn btn-success" id="battle_finish">Close Battle</button>
							<h4>Combat Log</h3>
							<table class="table">
								<thead>
									<tr>
										<th>Turn #</th>
										<th>Who</th>
										<th>Action</th>
									</tr>
								</thead>
								<tbody id="battle_combatLog">
								</tbody>
							</table>
						</div>
					</div>
				</div>
				<div class="col-md-4">
					<h2>Quest Log</h2>
					<div id="partList">
						<div id="area1_bossBattle">
							<div id="area1_prologe">
								<h2>Part 1</h2>
								After the end of your long quest you reach your final goal. <em class="area1_boss">Ada-Ra, King of Elements</em> reaches out to touch his sword to your weapon but you don't have one equipped, <strong>equip one from your inventory on the side to continue</strong>...
							</div>
							<div id="area1_postEquip" style="display: none;">
								<h2>Part 2</h2>
								You pull your <span id="area1_postEquip_itemName"></span> and meet it with <em class="area1_boss">Ada-Ra</em>'s mighty sword.
								<button class="btn btn-primary" id="area1_startBattle">Start Battle</button>
							</div>
							<div id="area1_battleWin" style="display: none;">
								<h2>Part 3</h2>
								Congratulations you have defeated <em class="area1_boss">Ada-Ra, King of Elements</em>.
							</div>
						</div>
					</div>
				</div>
				<div class="col-md-4">
					<div id="inventory">
						<h2>Inventory</h2>
						<div id="inventory_primary_weapon">
							<h3>Primary Weapon</h3>
							<ul class="nav nav-pills nav-stacked">

							</ul>
						</div>
						<div id="inventory_head">
							<h3>Head</h3>
							<ul class="nav nav-pills nav-stacked">

							</ul>
						</div>
						<div id="inventory_chestplate">
							<h3>Chest-plate</h3>
							<ul class="nav nav-pills nav-stacked">

							</ul>
						</div>
						<div id="inventory_gloves">
							<h3>Gloves</h3>
							<ul class="nav nav-pills nav-stacked">

							</ul>
						</div>
						<div id="inventory_boots">
							<h3>Boots</h3>
							<ul class="nav nav-pills nav-stacked">

							</ul>
						</div>
					</div>
				</div>
			</div>

			<div class="row" id="area2_credits" style="display: none;">
				<div class="col-md-6 col-md-offset-3">
					<h2>Credits</h2>
					<table class="table table-striped">
						<tbody id="area2_credits_table">

						</tbody>
					</table>
				</div>
			</div>
		</div>

		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>

		<script type="text/javascript">
		$(document).ready(function () {
			function rand(min, max) {
				return Math.floor(Math.random() * (max - min)) + min;
			} 

			//+ Jonas Raoni Soares Silva
			//@ http://jsfromhell.com/array/shuffle [v1.0]
			function shuffle(o){ //v1.0
				for(var j, x, i = o.length; i; j = Math.floor(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
				return o;
			};

			function appendElements(ele, child) {
				if (typeof child == "string") {
					ele.textContent = child;
				} else if (typeof child == "object" && child instanceof Array) {
					child.forEach(function (subChild) {
						appendElements(ele, subChild);
					});
				} else if (child instanceof HTMLElement) {
					ele.appendChild(child);
				} else {
					ele.textContent = child.toString();
				}
			}

			function e(type, attrs, body) {
				var ele = document.createElement(type);
				for (var key in attrs) {
					ele.setAttribute(key, attrs[key]);
				}
				appendElements(ele, body);
				return ele;
			}

			function getProgressBarColor(value) {
				if (value < 0.1) {
					return "progress-bar progress-bar-danger"
				} else if (value > 0.1 && value < 0.9) {
					return "progress-bar progress-bar-warning"
				} else {
					return "progress-bar progress-bar-success";
				}
			}

			var inventoryItems = {};

			function item_register(itemName, displayName, stats, events) {
				inventoryItems[itemName] = {
					name: itemName,
					displayName: displayName,
					stats: stats,
					events: events
				}
			}

			function item_emit(itemName, eventName, args) {
				if (inventoryItems[itemName] === undefined) {
					throw new Error("Item does not exist: " + str);
				}
				if (inventoryItems[itemName].events[eventName] !== undefined) {
					return inventoryItems[itemName].events[eventName].apply(inventoryItems[itemName], args);
				} else {
					return null;
				}
			}

			function item_get(itemName) {
				if (inventoryItems[itemName] === undefined) {
					throw new Error("Item does not exist: " + str);
				} else {
					return inventoryItems[itemName];
				}
			}

			function weapon_makeStats(minAttack, maxAttack, type) {
				return {
					minAttack: minAttack,
					maxAttack: maxAttack,
					type: type,
					slot: "primary_weapon"
				};
			}

			item_register("area1_sword", "Dave's Greatsword", weapon_makeStats(50, 400, "largeMelee"), area1_getItemEvents());
			item_register("area1_staff", "Flaming Hairy Staff", weapon_makeStats(50, 200, "magicRanged"), area1_getItemEvents());
			item_register("area1_bow", "Last Good Bow", weapon_makeStats(10, 300, "archerRanged"), area1_getItemEvents());
			item_register("area1_dagger", "Shard of Broken Time", weapon_makeStats(150, 300, "smallMelee"), area1_getItemEvents());

			var worldmonsters = {};

			function monster_regster(id, displayElement, stats, events) {
				worldmonsters[id] = {
					id: id,
					displayElement: displayElement,
					stats: stats,
					events: events
				}
			}

			function monster_get(monsterName) {
				if (worldmonsters[monsterName] === undefined) {
					throw new Error("monster does not exist: " + str);
				} else {
					return worldmonsters[monsterName];
				}
			}

			function monster_getWeaponDamage(monsterName, foeArmor) {
				var monster = monster_get(monsterName);
				var dmg = rand(monster.stats.minAttack, monster.stats.maxAttack);

				dmg *= foeArmor;

				return dmg;
			}

			monster_regster("area1_boss", e("em", {"class": "area1_boss"}, "Ada-Ra, King of Elements"), {
				minAttack: 20,
				maxAttack: 100,
				health: 5672,
				armor: 0.7,
				level: 1
			}, {
			});

			var charactor = {
				stats: {
					level: 1,
					armor: 0.25,
					health: 873
				},
				equipped: {},
				inventory: {},
				spells: []
			};

			function char_itemEquiped(itemName) {
				return charactor.equipped[item_get(itemName).stats.slot] == itemName;
			}

			function char_renderInventroy() {
				console.log("char_renderInventroy");
				$("#inventory_primary_weapon>ul").empty();
				$("#inventory_head>ul").empty();
				$("#inventory_chestplate>ul").empty();
				$("#inventory_gloves>ul").empty();
				$("#inventory_boots>ul").empty();

				for (var item in charactor.inventory) {
					var entryData = charactor.inventory[item];
					var itemData = item_get(item);
					if ($("#inventory_" + itemData.stats.slot + ">ul").length > 0) {
						var ele = null;
						var display = e("span", {}, [e("span", {}, itemData.displayName + " "), e("strong", {}, itemData.stats.minAttack + "-" + itemData.stats.maxAttack + " " + itemData.stats.type + " Damage")]);
						if (char_itemEquiped(item)) {
							ele = e("li", {"class": "active"}, e("a", {"data-name": itemData.name}, display));
						} else {
							ele = e("li", {}, e("a", {"data-name": itemData.name}, display));
						}
						$(ele).children("a").click(function (e) {
							e.preventDefault();
							char_equipItem($(this).attr("data-name"));
						});
						$("#inventory_" + itemData.stats.slot + ">ul").append(ele);
					} else {
						throw new Error("Bad Slot: " + itemData.stats.slot)
					}
				}
			}

			function char_equipItem(itemName) {
				charactor.equipped[item_get(itemName).stats.slot] = itemName;
				item_emit(itemName, "equip", []);
				char_renderInventroy();
			}

			function char_addToInventory(str) {
				if (inventoryItems[str] === undefined) {
					throw new Error("Item does not exist: " + str);
				}

				if (charactor.inventory[str] === undefined) {
					charactor.inventory[str] = {
						count: 0
					};
				}

				charactor.inventory[str].count++;

				item_emit(str, "add", []);
			}

			function char_getWeaponDamage(foeArmor) {
				var currentWeapon = item_get(charactor.equipped["primary_weapon"]);
				var dmg = rand(currentWeapon.stats.minAttack, currentWeapon.stats.maxAttack);

				dmg *= foeArmor;

				item_emit(charactor.equipped["primary_weapon"], "swing", [dmg]);
				return dmg;
			}

			var currentBattle = {
				foe: null,
				ownMaxHealth: null,
				ownHealth: null,
				foeMaxHealth: null,
				foeHealth: null,
				callback: null,
				victroy: null,
				turnNumber: 0
			};

			function battle_begin(monsterName, cb) {
				currentBattle.foe = monsterName;
				currentBattle.ownHealth = currentBattle.ownMaxHealth = charactor.stats.health;
				currentBattle.foeHealth = currentBattle.foeMaxHealth =  monster_get(monsterName).stats.health;
				currentBattle.turnNumber = 0;
				currentBattle.callback = cb;

				$("#battle").show();
				$("#battle_actions").show();
				$("#battle_finish").hide();
				$("#battle_monsterName").empty().append(monster_get(monsterName).displayElement.cloneNode(true));

				// Build spell list
				charactor.spells.forEach(function (spellName) {

				});

				// Build item list
				Object.keys(charactor.inventory).forEach(function (itemName) {

				});

				battle_renderHealth();
			}

			function battle_log(who, logText) {
				$("#battle_combatLog").prepend(e("tr", {}, [e("td", {}, currentBattle.turnNumber), e("td", {}, 
					who ? e("strong", {}, "You") : monster_get(currentBattle.foe).displayElement.cloneNode(true)),
					e("td", {}, e("span", {}, logText))]));
			}

			function battle_attack() {
				console.log("battle_attack");

				var ownDmg = char_getWeaponDamage(monster_get(currentBattle.foe).stats.armor);

				if (ownDmg > 0) {
					battle_log(true, "Hit for " + ownDmg.toFixed(2) + " damage");
				} else {
					battle_log(true, "Missed");
				}

				currentBattle.foeHealth -= ownDmg;

				battle_renderHealth();

				if (currentBattle.foeHealth < 0) {
					battle_end();
				} else {
					battle_processTurn();
				}
			}

			function battle_renderHealth() {
				var myHealthValue = (currentBattle.ownHealth / currentBattle.ownMaxHealth * 100).toFixed(2) + "%",
					foeHealthValue = (currentBattle.foeHealth / currentBattle.foeMaxHealth * 100).toFixed(2) + "%";
				$("#battle_myHealth")[0].style.width = myHealthValue;
				$("#battle_myHealth").attr("class", getProgressBarColor(currentBattle.ownHealth / currentBattle.ownMaxHealth));
				$("#battle_myHealthText").text("(" + currentBattle.ownHealth.toFixed(2) +
					" / " + currentBattle.ownMaxHealth.toFixed(2) + ") " + myHealthValue);
				$("#battle_foeHealth")[0].style.width = foeHealthValue;
				$("#battle_foeHealth").attr("class", getProgressBarColor(currentBattle.foeHealth / currentBattle.foeMaxHealth));
				$("#battle_foeHealthText").text("(" + currentBattle.foeHealth.toFixed(2) +
					" / " + currentBattle.foeMaxHealth.toFixed(2) + ") " + foeHealthValue);
			}

			function battle_processTurn() {
				// monster attack
				
				var foeDmg = monster_getWeaponDamage(currentBattle.foe, charactor.stats.armor);

				if (foeDmg > 0) {
					battle_log(false, "Hit for " + foeDmg.toFixed(2) + " damage");
				} else {
					battle_log(false, "Missed")
				}

				currentBattle.ownHealth -= foeDmg;

				battle_renderHealth();

				if (currentBattle.ownHealth < 0) {
					battle_end();
				}

				currentBattle.turnNumber++;
			}

			function battle_end() {
				currentBattle.victroy = false;

				if (currentBattle.foeHealth < 0 && currentBattle.ownHealth > 0) {
					currentBattle.victroy = true;
				}

				$("#battle_actions").hide();
				$("#battle_finish").show();
			}

			function battle_finish() {
				$("#battle").hide();
				currentBattle.callback(currentBattle.victroy);
			}

			// Hide inital items
			$("#partList").children().each(function (i, element) {
				$(element).hide();
			});

			$("#inventory").hide();
			$("#inventory_primary_weapon").hide();
			$("#inventory_head").hide();
			$("#inventory_chestplate").hide();
			$("#inventory_gloves").hide();
			$("#inventory_boots").hide();

			$("#battle").hide();
			$("#battle_attackButton").click(function (e) {
				e.preventDefault();
				$(this).hide();
				battle_attack();

				var self = this; // Stop the Cheese
				setTimeout(function () {
					$(self).show();
				}, 200);
			});
			$("#battle_finish").click(function (e) {
				e.preventDefault();
				battle_finish();
			});

			// area1: Prologue + credits
			function area1_start() {
				$("#area1_bossBattle").show();

				$("#inventory").show();
				$("#inventory_primary_weapon").show();

				char_addToInventory("area1_sword");
				char_addToInventory("area1_staff");
				char_addToInventory("area1_bow");
				char_addToInventory("area1_dagger");
				char_renderInventroy();
			}

			function area1_getItemEvents() {
				return {
					"equip": function () {
						area1_equipedItem(this.name);
					},
					"swing": function () {
						area1_swingItem(this.name);
					}
				};
			}

			function area1_equipedItem(itemName) {
				console.log("area1_equipedItem");
				$("#area1_postEquip").show();
				$("#area1_postEquip_itemName").text(item_get(itemName).displayName);
				$("#area1_startBattle").click(function (e) {
					e.preventDefault();
					$(this).hide();
					area1_beginBossBattle();
				});
			}

			function area1_beginBossBattle() {
				console.log("area1_beginBossBattle");
				battle_begin("area1_boss", function (victroy) {
					if (victroy) {
						$("#area1_battleWin").show();
						$("#area1_win").show();
					} else {
						// What am I going to do about losses, easier difficulty
					}
				});
			}

			function area1_swingItem(itemName) {
				console.log("area1_swingItem", itemName);
			}

			var area2_roles = [
				"Executive Producer", "", "",
				"Director",
				"Lead Gameplay Programmer",
				"Lead Engine Programmer",
				"Senior Gameplay Programmer", "", "", "",
				"Gameplay Programmer", "", "", "", "", "", "",
				"Senior Engine Programmer", "", "", "", "",
				"Engine Programmer", "", "", "", "", "", "",
				"Tools Programmer", "",
				"Lead Artist",
				"Senior Artist", "", "", "", "",
				"Artist", "", "", "", "", "", "",
				"Head of IT Support",
				"IT Support", "",
				"Building Manager",
				"Janitor", "", ""
			];

			// UOW Computer Science Staff
			var area2_names = [
				"Mark Apperley", 
				"David Bainbridge", 
				"Judy Bowen", 
				"Sally Jo Cunningham", 
				"Eibe Frank", 
				"Tomas Garcia Ferrari", 
				"Annika Hinze", 
				"Steve Jones", 
				"Doris Jung", 
				"Te Taka Keegan", 
				"Ryan Ko", 
				"Simon Laing", 
				"Robi Malik", 
				"Masood Masoodian", 
				"Michael Mayo", 
				"Tony McGregor", 
				"Richard Nelson", 
				"Dave Nichols", 
				"Bernhard Pfahringer", 
				"Steve Reeves", 
				"Bill Rogers", 
				"Sam Sarjant", 
				"Tony Smith", 
				"Keith Soo", 
				"Simon Spacey", 
				"Claire Timpany", 
				"Emmanuel Turner", 
				"Mark Utting", 
				"Nicholas (Nic) Vanderschantz", 
				"Ian Witten", 
				"Shaoqun Wu", 
				"Stefan Ruger", 
				"Robert Spence", 
				"Tim Elphick", 
				"Nilesh Kanji", 
				"Bronwyn Poki", 
				"Phil Treweek", 
				"Lesley Dick", 
				"Marian McPherson", 
				"Bronwyn Webster", 
				"Katherine Don", 
				"Dale Fletcher", 
				"Anupama Krishnan", 
				"Peter Reutemann", 
				"Albert Bifet", 
				"Remco Bouckaert", 
				"John Brine", 
				"J. Stephen Downie", 
				"Mark Hall", 
				"John Rose", 
				"Lloyd Smith"
			];

			var area2_nicknames = [
				"Sniper",
				"King",
				"LOL",
				"ROFL",
				"Warrior",
				"John",
				"Mark",
				"Simon",
				"Bull",
				"Queen",
				"Mitch",
				"Pig",
				"Lurker",
				"CompSci",
				"Rich",
				"Fang",
				"Bat",
				"Naughty"
			];

			if (area2_names.length != area2_roles.length) {
				throw new Error("Bad area2_names/area2_roles length, make sure they're the same");
			}

			function area2_start() {
				// Build credits
				$("#gameContainer").hide();

				area2_names = shuffle(area2_names);

				$("#area2_credits").show();

				area2_roles.forEach(function (role, index) {
					setTimeout(function () {
						$("#area2_credits_table").append(e("tr", {}, [e("td", {"style": "text-align: right; font-weight: bold;"}, role), e("td", {}, area2_names[index])]));
					}, (index) * 1000);
				});
			}

			function area2_generateComment() {
				var name = "";
				if (Math.random() > 0.5) {
					name += area2_nicknames[rand(0, area2_nicknames.length)];
				} else if (Math.random() > 0.5) {
					name += area2_nicknames[rand(0, area2_nicknames.length)] + area2_nicknames[rand(0, area2_nicknames.length)];
				} else {
					name += area2_nicknames[rand(0, area2_nicknames.length)] + "_" + area2_nicknames[rand(0, area2_nicknames.length)];
				}

				if (Math.random() > 0.25) {
					name += rand(0, 10000).toString();
				}

				if (Math.random() > 0.75) {
					name = name.toLowerCase();
				} else if (Math.random() > 0.75) {
					name = name.toUpperCase();
				}

				if (Math.random() > 0.75) {
					name = "xXx" + name + "xXx";
				} else if (Math.random() > 0.75) {
					name = "XxX" + name + "XxX";
				}

				return name;
			}

			for (var i = 0; i < 100; i++) {
				console.log(area2_generateComment());
			}

			window.area2_start = area2_start;

			area1_start();
		});
		</script>
	</body>
</html>